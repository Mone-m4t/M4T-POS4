<!DOCTYPE html>
<html lang="lo" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4338ca">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="M4T POS">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/T3XVwp6Z/1767710343039-2.png">
    <title>M4T POS - ‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫Ç‡∫≤‡∫ç‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans Lao', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-s::-webkit-scrollbar { display: none; }
        .wm-overlay { position: absolute; inset: 0; display: flex; flex-wrap: wrap; justify-content: center; align-content: center; transform: rotate(-30deg); pointer-events: none; z-index: 5; overflow: hidden; }
        .wm-text { font-size: 10px; color: rgba(0,0,0,0.05); font-weight: bold; padding: 10px; white-space: nowrap; }
        @media print { .no-p { display: none !important; } #receipt-print-area { display: block !important; position: absolute; top:0; left:0; width:100%; } }
        .btn-active:active { transform: scale(0.96); transition: 0.1s; }
        .modal-bg { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        #bt-status.connected { color: #10b981; }
    </style>
</head>
<body class="bg-gray-100 h-full flex flex-col overflow-hidden text-sm select-none">

    <header class="bg-indigo-700 text-white p-3 flex justify-between items-center shadow-lg no-p">
        <div class="flex items-center gap-2">
            <div class="bg-white text-indigo-700 p-1 rounded-lg font-bold">M4T</div>
            <div>
                <h1 class="font-bold leading-tight text-xs" id="head-title">M4T POS Pro</h1>
                <div id="bt-status" class="text-[9px] opacity-70">üî¥ Bluetooth: ‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà</div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="connectBT()" class="bg-blue-600 px-3 py-2 rounded-xl text-[10px] font-bold btn-active border border-blue-400">üîµ ‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà‡∫õ‡∫£‡∫¥‡∫ô‡ªÄ‡∫ï‡∫µ</button>
            <button onclick="askPass()" class="bg-indigo-600 px-3 py-2 rounded-xl text-[10px] font-bold btn-active border border-indigo-500">‚öôÔ∏è ‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô</button>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden no-p">
        <div class="flex-1 flex flex-col p-3 overflow-hidden">
            <div class="flex gap-2 mb-3">
                <input type="text" id="search" oninput="render()" placeholder="üîç ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤..." class="flex-1 p-2 rounded-xl border-none shadow-sm outline-none focus:ring-2 ring-indigo-500">
            </div>
            <div id="cats" class="flex gap-2 mb-3 overflow-x-auto pb-1 hide-s"></div>
            <div id="prod-grid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-5 gap-3 overflow-y-auto pr-1"></div>
        </div>

        <div class="w-full md:w-80 bg-white shadow-2xl flex flex-col border-l">
            <div class="p-3 bg-gray-50 border-b flex justify-between items-center font-bold text-xs uppercase text-gray-400">
                <span>‡∫ï‡∫∞‡∫Å‡ªâ‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</span><span id="c-count" class="bg-indigo-700 text-white px-2 rounded-full">0</span>
            </div>
            <div id="cart-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
            
            <div class="p-3 bg-white border-t space-y-2.5 shadow-[0_-4px_10px_rgba(0,0,0,0.05)]">
                <div class="grid grid-cols-2 gap-2">
                    <input id="cus" type="text" placeholder="‡∫ä‡∫∑‡ªà‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤..." class="border p-2 rounded-lg text-xs outline-none focus:border-indigo-500">
                    <select id="st" onchange="debtTog()" class="border p-2 rounded-lg text-xs bg-gray-50 outline-none">
                        <option value="‡∫à‡ªà‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß">‚úÖ ‡∫à‡ªà‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß</option>
                        <option value="‡∫ï‡∫¥‡∫î‡ªú‡∫µ‡ªâ">‚ö†Ô∏è ‡∫ï‡∫¥‡∫î‡ªú‡∫µ‡ªâ</option>
                    </select>
                </div>
                <input id="dd" type="date" class="hidden w-full border p-2 rounded-lg text-xs bg-yellow-50 outline-none">
                <div class="flex justify-between font-bold text-indigo-700 text-lg border-t pt-2"><span>‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</span><span id="g-total">0 ‚Ç≠</span></div>
                <div class="flex gap-1">
                    <label class="flex-1 cursor-pointer"><input type="radio" name="pm" value="‡ªÄ‡∫á‡∫¥‡∫ô‡∫™‡∫ª‡∫î" checked class="peer hidden"><div class="peer-checked:bg-indigo-600 peer-checked:text-white border text-center py-2 rounded-lg text-[10px] font-bold">‡ªÄ‡∫á‡∫¥‡∫ô‡∫™‡∫ª‡∫î</div></label>
                    <label class="flex-1 cursor-pointer"><input type="radio" name="pm" value="‡ªÇ‡∫≠‡∫ô" onclick="setQR(1)" class="peer hidden"><div class="peer-checked:bg-indigo-600 peer-checked:text-white border text-center py-2 rounded-lg text-[10px] font-bold">‡ªÇ‡∫≠‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô</div></label>
                </div>
                <input id="rec" type="number" class="w-full border-2 border-gray-100 p-2.5 rounded-xl text-center font-bold text-lg outline-none" placeholder="‡∫Æ‡∫±‡∫ö‡ªÄ‡∫á‡∫¥‡∫ô‡∫°‡∫≤...">
                <button id="pay-btn" onclick="pay()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg btn-active uppercase tracking-wider">‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫Ç‡∫≤‡∫ç</button>
            </div>
        </div>
    </main>

    <div id="adminM" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-[500] p-4">
        <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl">
            <div class="p-4 bg-indigo-700 text-white flex justify-between items-center">
                <b class="text-lg">‚öôÔ∏è ‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤ ‡ªÅ‡∫•‡∫∞ ‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô</b>
                <button onclick="closeM('adminM')" class="text-2xl">‚úï</button>
            </div>
            <div class="p-4 grid grid-cols-2 gap-3">
                <button onclick="openM('prodM')" class="p-4 bg-gray-50 rounded-2xl border hover:bg-indigo-50 text-center">üì¶<br>‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</button>
                <button onclick="showHist()" class="p-4 bg-gray-50 rounded-2xl border hover:bg-indigo-50 text-center">üìú<br>‡∫õ‡∫∞‡∫´‡∫ß‡∫±‡∫î</button>
                <button onclick="openM('shopM')" class="p-4 bg-gray-50 rounded-2xl border hover:bg-indigo-50 text-center">üè†<br>‡∫Æ‡ªâ‡∫≤‡∫ô‡∫Ñ‡ªâ‡∫≤</button>
                <button onclick="saveAndDownloadHTML()" class="p-4 bg-green-50 rounded-2xl border border-green-200 hover:bg-green-100 text-center text-green-700 font-bold">üíæ<br>‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫ª‡∫á‡ªÑ‡∫ü‡∫•‡ªå</button>
            </div>
            <div class="p-4 border-t flex flex-col gap-2">
                <button onclick="importData()" class="w-full py-2 text-indigo-600 font-bold">üì• ‡∫ô‡∫≥‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô (Restore)</button>
                <button onclick="clearAllData()" class="w-full py-2 text-red-400 text-xs">‡∫•‡ªâ‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</button>
            </div>
        </div>
    </div>

    <div id="prodM" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-[510] p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center">
                <b class="text-lg">‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</b>
                <button onclick="closeM('prodM')" class="text-2xl">‚úï</button>
            </div>
            <div class="p-4 bg-gray-50 space-y-2">
                <div class="grid grid-cols-2 gap-2">
                    <input id="p-n" type="text" placeholder="‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤" class="p-2 border rounded-lg outline-none">
                    <input id="p-p" type="number" placeholder="‡∫•‡∫≤‡∫Ñ‡∫≤" class="p-2 border rounded-lg outline-none">
                    <input id="p-c" type="text" placeholder="‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà" class="p-2 border rounded-lg outline-none">
                    <input id="p-i" type="text" placeholder="Link ‡∫Æ‡∫π‡∫ö" class="p-2 border rounded-lg outline-none">
                </div>
                <button onclick="saveProd()" class="w-full bg-indigo-600 text-white py-2 rounded-xl font-bold">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</button>
            </div>
            <div id="p-list" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
        </div>
    </div>

    <div id="shopM" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-[510] p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-xl mb-4">‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Æ‡ªâ‡∫≤‡∫ô‡∫Ñ‡ªâ‡∫≤</h3>
            <div class="space-y-3">
                <input id="s-n" type="text" placeholder="‡∫ä‡∫∑‡ªà‡∫Æ‡ªâ‡∫≤‡∫ô" class="w-full p-3 border rounded-xl outline-none">
                <input id="s-t" type="text" placeholder="‡∫ó‡∫µ‡ªà‡∫¢‡∫π‡ªà/‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó" class="w-full p-3 border rounded-xl outline-none">
                <input id="s-q" type="text" placeholder="Link QR Code" class="w-full p-3 border rounded-xl outline-none">
                <button onclick="saveShop()" class="w-full bg-indigo-700 text-white py-3 rounded-xl font-bold btn-active">‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å</button>
                <button onclick="closeM('shopM')" class="w-full py-2 text-gray-400 text-center">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
            </div>
        </div>
    </div>

    <div id="qrM" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[600] p-6 backdrop-blur-sm">
        <div class="bg-white p-5 rounded-3xl max-w-xs w-full text-center">
            <h3 class="font-bold mb-4">‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÇ‡∫≠‡∫ô</h3>
            <img id="qr-img" src="" class="w-full rounded-2xl mb-5 border-4 border-gray-50">
            <button onclick="setQR(0)" class="w-full bg-indigo-600 text-white py-3 rounded-2xl font-bold">‡∫õ‡∫¥‡∫î</button>
        </div>
    </div>

    <div id="histM" class="hidden fixed inset-0 modal-bg flex items-center justify-center p-4 z-[510]">
        <div class="bg-white rounded-3xl w-full max-w-lg max-h-[85vh] flex flex-col overflow-hidden shadow-2xl">
            <div class="p-4 border-b bg-indigo-700 text-white flex justify-between items-center">
                <div><b class="text-lg">‡∫õ‡∫∞‡∫´‡∫ß‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫Ç‡∫≤‡∫ç</b><p id="m-summary" class="text-[10px] opacity-80"></p></div>
                <button onclick="closeM('histM')" class="text-2xl">‚úï</button>
            </div>
            <div id="h-list" class="overflow-y-auto p-4 space-y-3 bg-gray-100 flex-1"></div>
        </div>
    </div>

    <div id="receipt-print-area" class="fixed -left-[1000px] top-0"></div>
    <div id="toast" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-3 rounded-full text-white z-[1000] text-xs font-bold shadow-2xl animate-bounce"></div>

<script id="app-core">
const PASS = "212004";
let bleDevice, bleCharacteristic;

// --- DATA SEED (This part is updated automatically on Save) ---
let items = JSON.parse(localStorage.getItem('m4t_items')) || [{"id":1,"n":"‡∫ô‡ªâ‡∫≥‡∫î‡∫∑‡ªà‡∫°","p":5000,"c":"‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°","img":"https://images.unsplash.com/photo-1548919973-5dea5846f669?w=150"},{"id":2,"n":"‡∫Å‡∫≤‡ªÄ‡∫ü","p":25000,"c":"‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°","img":"https://images.unsplash.com/photo-1517701604599-bb29b565090c?w=150"}];
let shop = JSON.parse(localStorage.getItem('m4t_shop')) || { n: "M4T POS SHOP", t: "‡∫ö‡ªâ‡∫≤‡∫ô‡∫î‡∫≠‡∫ô‡∫î‡∫π‡ªà | 020 9787 0611", q: "" };
let sales = JSON.parse(localStorage.getItem('m4t_v3') || '[]');
// -------------------------------------------------------------

let cart = [], curCat = 'all';
const el = id => document.getElementById(id);
const openM = id => el(id).classList.remove('hidden');
const closeM = id => el(id).classList.add('hidden');

function render() {
    const q = el('search').value.toLowerCase();
    const filtered = items.filter(i => (curCat === 'all' || i.c === curCat) && i.n.toLowerCase().includes(q));
    el('prod-grid').innerHTML = filtered.map(i => `
        <div onclick="add(${i.id})" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden active:scale-95 transition-all cursor-pointer">
            <img src="${i.img || 'https://via.placeholder.com/150'}" class="w-full h-24 object-cover">
            <div class="p-2 text-center">
                <h3 class="text-[11px] font-bold truncate">${i.n}</h3>
                <p class="text-indigo-600 font-bold text-xs">${i.p.toLocaleString()} ‚Ç≠</p>
            </div>
        </div>`).join('');
    
    const cats = ['all', ...new Set(items.map(i => i.c))];
    el('cats').innerHTML = cats.map(c => `
        <button onclick="setCat('${c}')" class="${curCat===c ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700'} px-5 py-1.5 rounded-full text-xs border shadow-sm whitespace-nowrap">${c === 'all' ? '‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î' : c}</button>
    `).join('');
    el('qr-img').src = shop.q;
    el('head-title').innerHTML = `${shop.n}<br><span class="text-[9px] opacity-70">‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫û‡ªâ‡∫≠‡∫°‡ªÉ‡∫ä‡ªâ‡∫á‡∫≤‡∫ô</span>`;
}

function saveProd() {
    const n = el('p-n').value, p = +el('p-p').value, c = el('p-c').value, img = el('p-i').value;
    if(!n || !p) return msg("‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ö‡ªç‡ªà‡∫Ñ‡∫ª‡∫ö!","bg-red-600");
    items.push({ id: Date.now(), n, p, c: c || '‡∫≠‡∫∑‡ªà‡∫ô‡ªÜ', img });
    syncAndNotify();
    el('p-n').value = el('p-p').value = el('p-c').value = el('p-i').value = '';
}

function syncAndNotify() {
    localStorage.setItem('m4t_items', JSON.stringify(items));
    render(); 
    updPList();
    msg("‡∫≠‡∫±‡∫ö‡ªÄ‡∫î‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß! ‡∫¢‡ªà‡∫≤‡∫•‡∫∑‡∫°‡∫Å‡∫ª‡∫î '‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫ª‡∫á‡ªÑ‡∫ü‡∫•‡ªå'", "bg-blue-600");
}

function saveAndDownloadHTML() {
    const currentHTML = document.documentElement.outerHTML;
    const dataString = JSON.stringify(items);
    const shopString = JSON.stringify(shop);
    
    // Replace the data seed in the code string
    let newHTML = currentHTML.replace(/let items = JSON\.parse\(localStorage\.getItem\('m4t_items'\)\) \|\| \[.*?\];/, `let items = JSON.parse(localStorage.getItem('m4t_items')) || ${dataString};`);
    newHTML = newHTML.replace(/let shop = JSON\.parse\(localStorage\.getItem\('m4t_shop'\)\) \|\| \{.*?\};/, `let shop = JSON.parse(localStorage.getItem('m4t_shop')) || ${shopString};`);

    const blob = new Blob([newHTML], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'M4T_POS_Updated.html';
    a.click();
    msg("‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å ‡ªÅ‡∫•‡∫∞ ‡∫™‡ªâ‡∫≤‡∫á‡ªÑ‡∫ü‡∫•‡ªå‡ªÉ‡ªù‡ªà‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!");
}

// --- Bluetooth & Print Logic ---
async function connectBT() {
    try {
        msg("‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤...", "bg-blue-500");
        bleDevice = await navigator.bluetooth.requestDevice({
            filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }, { namePrefix: 'MTP' }, { namePrefix: 'RPP' }, { namePrefix: 'Bluetooth' }],
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });
        const server = await bleDevice.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        const characteristics = await service.getCharacteristics();
        bleCharacteristic = characteristics.find(c => c.properties.write || c.properties.writeWithoutResponse);
        el('bt-status').innerText = "üü¢ Bluetooth: ‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà‡ªÅ‡∫•‡ªâ‡∫ß";
        el('bt-status').classList.add('connected');
        msg("‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!");
    } catch (e) { msg("‡∫Å‡∫≤‡∫ô‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà‡∫´‡∫º‡∫ª‡ªâ‡∫°‡ªÄ‡∫´‡∫º‡∫ß", "bg-red-500"); }
}

async function sendToPrinter(blob) {
    if (!bleCharacteristic) return;
    const arrayBuffer = await blob.arrayBuffer();
    const uint8Array = new Uint8Array(arrayBuffer);
    const chunkSize = 100;
    for (let i = 0; i < uint8Array.length; i += chunkSize) {
        await bleCharacteristic.writeValue(uint8Array.slice(i, i + chunkSize));
    }
}

async function printProcess(s) {
    const its = JSON.parse(s.items);
    let wms = ''; for(let i=0; i<12; i++) wms += `<div class="wm-text">${s.id}</div>`;
    const printEl = el('receipt-print-area');
    printEl.innerHTML = `
        <div id="r-cap" class="relative p-6 w-[350px] bg-white text-black border shadow-lg overflow-hidden">
            <div class="wm-overlay">${wms}</div>
            <div class="relative z-10 text-center">
                <h2 class="font-bold text-xl leading-tight uppercase text-indigo-800">${shop.n}</h2>
                <p class="text-[10px] text-gray-500 mb-2">${shop.t}</p>
                <div class="border-t-2 border-dashed border-gray-200 my-3"></div>
                <div class="text-left text-[10px] space-y-1">
                    <div class="flex justify-between"><span>‡ªÄ‡∫•‡∫Å‡∫ö‡∫¥‡∫ô:</span><span class="font-bold">${s.id}</span></div>
                    <div class="flex justify-between"><span>‡∫ß‡∫±‡∫ô‡∫ó‡∫µ:</span><span>${new Date(s.time).toLocaleString('lo-LA')}</span></div>
                    <div class="flex justify-between"><span>‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤:</span><span>${s.cus}</span></div>
                    <div class="flex justify-between"><span>‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞:</span><span class="font-bold underline">${s.st}</span></div>
                </div>
                <div class="border-t border-gray-100 my-3"></div>
                <div class="space-y-2">
                    ${its.map(i => `<div class="flex justify-between text-[11px]"><div class="text-left"><div class="font-bold">${i.n}</div><div class="text-[9px] text-gray-400">${i.p.toLocaleString()} x ${i.q}</div></div><span class="font-bold">${(i.p*i.q).toLocaleString()}</span></div>`).join('')}
                </div>
                <div class="border-t-2 border-dashed border-gray-200 my-3"></div>
                <div class="flex justify-between font-bold text-lg text-indigo-900 italic"><span>‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î:</span><span>${s.total.toLocaleString()} ‚Ç≠</span></div>
                <div class="bg-gray-50 p-2 mt-2 rounded-lg space-y-1">
                    <div class="flex justify-between text-[10px]"><span>‡∫Æ‡∫±‡∫ö‡ªÄ‡∫á‡∫¥‡∫ô (${s.pm}):</span><span>${s.rec.toLocaleString()}</span></div>
                    <div class="flex justify-between text-[10px] font-bold"><span>‡ªÄ‡∫á‡∫¥‡∫ô‡∫ó‡∫≠‡∫ô:</span><span>${s.chg.toLocaleString()}</span></div>
                </div>
                <div class="mt-6 text-[10px] font-bold italic opacity-60"><p>‡∫Ç‡∫≠‡∫ö‡ªÉ‡∫à‡∫ó‡∫µ‡ªà‡∫°‡∫≤‡∫≠‡∫∏‡∫î‡ªú‡∫π‡∫ô üôèüèª</p><p class="text-[8px] mt-1">Powered by M4T POS</p></div>
            </div>
        </div>`;
    await new Promise(r => setTimeout(r, 500));
    const canvas = await html2canvas(el('r-cap'), { scale: 3, useCORS: true, backgroundColor: "#ffffff" });
    if (bleCharacteristic) {
        const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
        await sendToPrinter(blob);
    } else {
        const link = document.createElement('a');
        link.download = `Receipt_${s.id}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
        msg("‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÉ‡∫ö‡∫ö‡∫¥‡∫ô‡∫•‡∫ª‡∫á‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡ªÅ‡∫•‡ªâ‡∫ß");
    }
}

// --- Cart & Sale Logic ---
function setCat(c) { curCat = c; render(); }
function add(id) { const x = cart.find(i => i.id === id); x ? x.q++ : cart.push({...items.find(i => i.id === id), q:1}); updCart(); }
function qty(id, d) { const i = cart.find(x => x.id === id); if(i) i.q += d; cart = cart.filter(x => x.q > 0); updCart(); }

function updCart() {
    let t = 0;
    el('cart-list').innerHTML = cart.map(i => { t += i.p * i.q; return `
        <div class="flex justify-between items-center bg-gray-50 p-2.5 rounded-xl border border-gray-100 text-xs">
            <div class="flex-1 truncate"><b>${i.n}</b><br><span class="opacity-50">${i.p.toLocaleString()} x ${i.q}</span></div>
            <div class="flex items-center gap-2">
                <button onclick="qty(${i.id},-1)" class="w-7 h-7 bg-white border rounded-lg shadow-sm">-</button>
                <b class="w-5 text-center">${i.q}</b>
                <button onclick="qty(${i.id},1)" class="w-7 h-7 bg-white border rounded-lg shadow-sm">+</button>
            </div></div>` }).join('');
    el('c-count').innerText = cart.length;
    el('g-total').innerText = t.toLocaleString() + ' ‚Ç≠';
}

async function pay() {
    const total = cart.reduce((a,b)=>a+(b.p*b.q),0), rVal = +el('rec').value || 0, pm = document.querySelector('input[name="pm"]:checked').value, st = el('st').value;
    if(!cart.length || (pm==='‡ªÄ‡∫á‡∫¥‡∫ô‡∫™‡∫ª‡∫î' && st==='‡∫à‡ªà‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß' && rVal < total)) return msg('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô‡∫Æ‡∫±‡∫ö‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö!','bg-red-600');
    const s = { id: 'INV'+Date.now().toString().slice(-8), items: JSON.stringify(cart), total, pm, st, dd: el('dd').value, cus: el('cus').value || '‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤‡∫ó‡∫ª‡ªà‡∫ß‡ªÑ‡∫õ', rec: pm==='‡ªÄ‡∫á‡∫¥‡∫ô‡∫™‡∫ª‡∫î' ? rVal : total, chg: (rVal > total ? rVal - total : 0), time: new Date() };
    sales.push(s); localStorage.setItem('m4t_v3', JSON.stringify(sales));
    msg('‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫™‡ªâ‡∫≤‡∫á‡ªÉ‡∫ö‡∫ö‡∫¥‡∫ô...');
    await printProcess(s);
    cart = []; updCart(); 
    el('rec').value = el('cus').value = el('dd').value = ''; 
}

// --- Helper Functions ---
function askPass() { if(prompt("‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ú‡ªà‡∫≤‡∫ô:") === PASS) openM('adminM'); else msg("‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ú‡∫¥‡∫î!","bg-red-600"); }
function saveShop() {
    shop = { n: el('s-n').value || shop.n, t: el('s-t').value || shop.t, q: el('s-q').value || shop.q };
    localStorage.setItem('m4t_shop', JSON.stringify(shop));
    msg("‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î"); render(); closeM('shopM');
}
function updPList() {
    el('p-list').innerHTML = items.map(i => `
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg border">
            <div class="text-xs"><b>${i.n}</b><br><span class="text-indigo-600">${i.p.toLocaleString()} ‚Ç≠</span></div>
            <button onclick="delP(${i.id})" class="text-red-500 text-xs">‡∫•‡∫∂‡∫ö</button>
        </div>`).join('');
}
function delP(id) { items = items.filter(i=>i.id!==id); syncAndNotify(); }
function showHist() {
    openM('histM');
    const now = new Date(), mTotal = sales.filter(s => new Date(s.time).getMonth() === now.getMonth()).reduce((a,b)=>a+b.total,0);
    el('m-summary').innerText = `‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô‡∫ô‡∫µ‡ªâ: ${mTotal.toLocaleString()} ‚Ç≠ | ${sales.length} ‡∫ö‡∫¥‡∫ô`;
    el('h-list').innerHTML = sales.sort((a,b)=>new Date(b.time)-new Date(a.time)).map(s => `
        <div class="bg-white p-3 rounded-2xl border flex justify-between items-center shadow-sm">
            <div class="text-[11px]"><b class="text-indigo-700">${s.cus}</b><br><span class="opacity-50">${new Date(s.time).toLocaleString()}</span></div>
            <div class="text-right">
                <b class="text-xs">${s.total.toLocaleString()} ‚Ç≠</b><br>
                <div class="flex gap-2 mt-1">
                    <button onclick="reP('${s.id}')" class="text-indigo-600 text-[10px] bg-indigo-50 px-2 rounded-lg">‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫ö‡∫¥‡∫ô/‡∫û‡∫¥‡∫°</button>
                    <button onclick="delS('${s.id}')" class="text-red-500 text-[10px]">‡∫•‡∫∂‡∫ö</button>
                </div>
            </div>
        </div>`).join('');
}
function delS(id) { if(confirm('‡∫•‡∫∂‡∫ö‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ô‡∫µ‡ªâ?')) { sales = sales.filter(s=>s.id!==id); localStorage.setItem('m4t_v3', JSON.stringify(sales)); showHist(); } }
function reP(id) { const s = sales.find(x => x.id === id); if(s) printProcess(s); }
function importData() {
    const input = document.createElement('input'); input.type = 'file';
    input.onchange = e => {
        const reader = new FileReader();
        reader.onload = rs => {
            const d = JSON.parse(rs.target.result);
            localStorage.setItem('m4t_items', JSON.stringify(d.items));
            localStorage.setItem('m4t_shop', JSON.stringify(d.shop));
            localStorage.setItem('m4t_v3', JSON.stringify(d.sales));
            location.reload();
        };
        reader.readAsText(e.target.files[0]);
    };
    input.click();
}
function clearAllData() { if(confirm("‡∫Ñ‡∫≥‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô: ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫à‡∫∞‡∫ñ‡∫∑‡∫Å‡∫•‡∫∂‡∫ö‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î!")) { localStorage.clear(); location.reload(); } }
function msg(m, c='bg-green-600') { 
    const t = el('toast'); t.innerText = m; 
    t.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-3 rounded-full text-white z-[1000] text-xs font-bold ${c}`; 
    t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2500); 
}
function debtTog() { el('dd').classList.toggle('hidden', el('st').value !== '‡∫ï‡∫¥‡∫î‡ªú‡∫µ‡ªâ'); }
function setQR(sw) { el('qrM').classList.toggle('hidden', !sw); }

// Initial load
render(); updPList();
el('s-n').value = shop.n; el('s-t').value = shop.t; el('s-q').value = shop.q;
</script>
</body>
</html>