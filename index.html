<!DOCTYPE html>
<html lang="lo" class="h-full">
<head>
    <script src="m4t-guardian.php"></script> 

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4338ca">
    ...
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="M4T POS">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/T3XVwp6Z/1767710343039-2.png">
    <title>M4T POS - ‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫Ç‡∫≤‡∫ç‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫≠‡∫≤‡∫ä‡∫µ‡∫ö</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans Lao', sans-serif; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { touch-action: manipulation; }
        .hide-s::-webkit-scrollbar { display: none; }
        
        /* Advanced Watermark System */
        .wm-container {
            position: absolute;
            inset: 0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 10px;
            pointer-events: none;
            z-index: 1;
            opacity: 0.04;
            transform: rotate(-25deg) scale(1.2);
            overflow: hidden;
        }
        .wm-item {
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            color: #000;
        }

        @media print { .no-p { display: none !important; } }
        .btn-active:active { transform: scale(0.95); transition: 0.1s; }
        .modal-bg { background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); transition: 0.3s; }
        #bt-status.connected { color: #10b981; font-weight: bold; }
        .product-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .product-card:active { transform: scale(0.92); opacity: 0.8; }
    </style>
</head>
<body class="bg-slate-100 h-full flex flex-col overflow-hidden text-sm select-none">

    <header class="bg-indigo-700 text-white p-3 flex justify-between items-center shadow-md z-50 no-p">
        <div class="flex items-center gap-3">
            <div class="bg-white text-indigo-700 p-1.5 rounded-xl shadow-inner font-black text-lg">M4T</div>
            <div>
                <h1 class="font-bold leading-tight text-sm truncate max-w-[120px]" id="head-title">M4T POS Pro</h1>
                <div id="bt-status" class="text-[10px] opacity-80 flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Bluetooth: ‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà
                </div>
            </div>
        </div>
        <div class="flex gap-1.5">
            <button onclick="connectBT()" class="bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded-xl text-[10px] font-bold btn-active border border-blue-400 shadow-sm">üîµ Printer</button>
            <button onclick="askPass()" class="bg-indigo-800 hover:bg-indigo-600 px-3 py-2 rounded-xl text-[10px] font-bold btn-active border border-indigo-500 shadow-sm">‚öôÔ∏è ‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤</button>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden no-p">
        <div class="flex-1 flex flex-col p-3 overflow-hidden">
            <div class="relative mb-3">
                <input type="text" id="search" oninput="render()" placeholder="üîç ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ ‡∫´‡∫º‡∫∑ ‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î..." 
                    class="w-full p-3.5 pl-10 rounded-2xl border-none shadow-md outline-none focus:ring-2 ring-indigo-500 bg-white">
            </div>
            <div id="cats" class="flex gap-2 mb-3 overflow-x-auto pb-2 hide-s"></div>
            <div id="prod-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 overflow-y-auto pr-1 pb-20"></div>
        </div>

        <div class="w-full md:w-96 bg-white shadow-[0_-10px_30px_rgba(0,0,0,0.1)] flex flex-col border-l z-40">
            <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                <span class="font-black text-gray-500 uppercase tracking-widest text-[10px]">‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ó‡∫µ‡ªà‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å</span>
                <span id="c-count" class="bg-indigo-600 text-white px-3 py-0.5 rounded-full text-xs font-bold shadow-lg">0</span>
            </div>
            <div id="cart-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white"></div>
            
            <div class="p-4 bg-white border-t border-gray-100 space-y-3 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                <div class="grid grid-cols-2 gap-2">
                    <input id="cus" type="text" placeholder="üë§ ‡∫ä‡∫∑‡ªà‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤..." class="border p-2.5 rounded-xl text-xs outline-none focus:ring-2 ring-indigo-200">
                    <select id="st" onchange="debtTog()" class="border p-2.5 rounded-xl text-xs bg-gray-50 font-bold outline-none">
                        <option value="‡∫à‡ªà‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß">‚úÖ ‡∫à‡ªà‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß</option>
                        <option value="‡∫ï‡∫¥‡∫î‡ªú‡∫µ‡ªâ">‚ö†Ô∏è ‡∫ï‡∫¥‡∫î‡ªú‡∫µ‡ªâ</option>
                    </select>
                </div>
                <input id="dd" type="date" class="hidden w-full border p-2.5 rounded-xl text-xs bg-yellow-50 outline-none">
                
                <div class="flex justify-between items-end border-t pt-3">
                    <span class="text-gray-400 font-bold text-xs uppercase">‡∫ç‡∫≠‡∫î‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</span>
                    <span id="g-total" class="font-black text-indigo-700 text-2xl tracking-tighter">0 ‚Ç≠</span>
                </div>

                <div class="flex gap-2">
                    <label class="flex-1 cursor-pointer group">
                        <input type="radio" name="pm" value="‡ªÄ‡∫á‡∫¥‡∫ô‡∫™‡∫ª‡∫î" checked class="peer hidden">
                        <div class="peer-checked:bg-indigo-600 peer-checked:text-white border-2 border-transparent bg-gray-100 text-gray-600 text-center py-2.5 rounded-xl text-xs font-bold transition-all group-active:scale-95">üíµ ‡ªÄ‡∫á‡∫¥‡∫ô‡∫™‡∫ª‡∫î</div>
                    </label>
                    <label class="flex-1 cursor-pointer group">
                        <input type="radio" name="pm" value="‡ªÇ‡∫≠‡∫ô" onclick="setQR(1)" class="peer hidden">
                        <div class="peer-checked:bg-indigo-600 peer-checked:text-white border-2 border-transparent bg-gray-100 text-gray-600 text-center py-2.5 rounded-xl text-xs font-bold transition-all group-active:scale-95">üì± ‡ªÇ‡∫≠‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô</div>
                    </label>
                </div>

                <div class="relative">
                    <input id="rec" type="number" class="w-full bg-gray-50 border-2 border-gray-100 p-3.5 rounded-2xl text-center font-black text-xl outline-none focus:border-green-500 focus:bg-white transition-all" placeholder="‡∫Æ‡∫±‡∫ö‡ªÄ‡∫á‡∫¥‡∫ô‡∫°‡∫≤‡∫ô‡∫µ‡ªâ...">
                </div>

                <button id="pay-btn" onclick="pay()" class="w-full bg-green-600 hover:bg-green-500 text-white font-black py-4 rounded-2xl shadow-xl btn-active uppercase tracking-widest text-lg">‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫Ç‡∫≤‡∫ç</button>
            </div>
        </div>
    </main>

    <div id="adminM" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-[500] p-4">
        <div class="bg-white rounded-[2.5rem] w-full max-w-md overflow-hidden shadow-2xl">
            <div class="p-6 bg-indigo-700 text-white flex justify-between items-center">
                <b class="text-xl">‚öôÔ∏è ‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</b>
                <button onclick="closeM('adminM')" class="w-10 h-10 flex items-center justify-center bg-white/20 rounded-full text-xl">‚úï</button>
            </div>
            <div class="p-6 grid grid-cols-2 gap-4">
                <button onclick="openM('prodM')" class="p-6 bg-slate-50 rounded-3xl border-2 border-transparent hover:border-indigo-500 transition-all text-center group">
                    <span class="text-3xl block mb-2 group-hover:scale-110 transition-transform">üì¶</span>
                    <b class="text-gray-700">‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</b>
                </button>
                <button onclick="showHist()" class="p-6 bg-slate-50 rounded-3xl border-2 border-transparent hover:border-indigo-500 transition-all text-center group">
                    <span class="text-3xl block mb-2 group-hover:scale-110 transition-transform">üìú</span>
                    <b class="text-gray-700">‡∫õ‡∫∞‡∫´‡∫ß‡∫±‡∫î‡∫Ç‡∫≤‡∫ç</b>
                </button>
                <button onclick="openM('shopM')" class="p-6 bg-slate-50 rounded-3xl border-2 border-transparent hover:border-indigo-500 transition-all text-center group">
                    <span class="text-3xl block mb-2 group-hover:scale-110 transition-transform">üè†</span>
                    <b class="text-gray-700">‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Æ‡ªâ‡∫≤‡∫ô</b>
                </button>
                <button onclick="exportData()" class="p-6 bg-slate-50 rounded-3xl border-2 border-transparent hover:border-indigo-500 transition-all text-center group">
                    <span class="text-3xl block mb-2 group-hover:scale-110 transition-transform">üíæ</span>
                    <b class="text-gray-700">Backup</b>
                </button>
            </div>
            <div class="p-6 border-t bg-gray-50 flex flex-col gap-3">
                <button onclick="importData()" class="w-full py-3 bg-white text-indigo-600 font-bold rounded-2xl shadow-sm">üì• Restore (‡∫ô‡∫≥‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô)</button>
                <button onclick="clearAllData()" class="w-full py-2 text-red-400 text-[10px] font-bold uppercase tracking-widest">Format Data (‡∫•‡ªâ‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î)</button>
            </div>
        </div>
    </div>

    <div id="prodM" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-[510] p-4">
        <div class="bg-white rounded-[2rem] w-full max-w-lg max-h-[90vh] flex flex-col overflow-hidden shadow-2xl">
            <div class="p-5 border-b flex justify-between items-center bg-white sticky top-0">
                <b class="text-lg">‡∫™‡∫≤‡∫á‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</b>
                <button onclick="closeM('prodM')" class="text-2xl">‚úï</button>
            </div>
            <div class="p-5 bg-indigo-50 space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <input id="p-n" type="text" placeholder="‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤" class="p-3 rounded-xl border-none shadow-sm outline-none">
                    <input id="p-p" type="number" placeholder="‡∫•‡∫≤‡∫Ñ‡∫≤" class="p-3 rounded-xl border-none shadow-sm outline-none">
                    <input id="p-c" type="text" placeholder="‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà" class="p-3 rounded-xl border-none shadow-sm outline-none">
                    <input id="p-i" type="text" placeholder="Link ‡∫Æ‡∫π‡∫ö (‡∫ñ‡ªâ‡∫≤‡∫°‡∫µ)" class="p-3 rounded-xl border-none shadow-sm outline-none">
                </div>
                <button onclick="saveProd()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡ªÉ‡ªù‡ªà</button>
            </div>
            <div id="p-list" class="flex-1 overflow-y-auto p-5 space-y-3"></div>
        </div>
    </div>

    <div id="shopM" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-[510] p-4">
        <div class="bg-white rounded-[2rem] w-full max-w-sm p-8 shadow-2xl">
            <h3 class="font-black text-2xl mb-6 text-center">‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Æ‡ªâ‡∫≤‡∫ô‡∫Ñ‡ªâ‡∫≤</h3>
            <div class="space-y-4">
                <input id="s-n" type="text" placeholder="‡∫ä‡∫∑‡ªà‡∫Æ‡ªâ‡∫≤‡∫ô" class="w-full p-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-indigo-500">
                <input id="s-t" type="text" placeholder="‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó / ‡∫ó‡∫µ‡ªà‡∫¢‡∫π‡ªà" class="w-full p-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-indigo-500">
                <input id="s-q" type="text" placeholder="Link QR ‡∫Æ‡∫±‡∫ö‡ªÄ‡∫á‡∫¥‡∫ô (URL)" class="w-full p-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-indigo-500">
                <button onclick="saveShop()" class="w-full bg-indigo-700 text-white py-4 rounded-2xl font-bold btn-active shadow-xl">‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</button>
                <button onclick="closeM('shopM')" class="w-full py-2 text-gray-400 font-bold">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
            </div>
        </div>
    </div>

    <div id="qrM" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-[600] p-8 backdrop-blur-md">
        <div class="bg-white p-6 rounded-[2.5rem] max-w-xs w-full text-center shadow-2xl">
            <h3 class="font-bold text-gray-800 mb-5">‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡∫ú‡ªà‡∫≤‡∫ô‡ªÅ‡∫≠‡∫±‡∫ö‡∫ó‡∫∞‡∫ô‡∫≤‡∫Ñ‡∫≤‡∫ô</h3>
            <div class="p-2 border-4 border-dashed border-indigo-100 rounded-3xl mb-6">
                <img id="qr-img" src="" class="w-full rounded-2xl shadow-sm">
            </div>
            <button onclick="setQR(0)" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">‡∫Ç‡ªâ‡∫≠‡∫ç‡ªÇ‡∫≠‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß</button>
        </div>
    </div>

    <div id="histM" class="hidden fixed inset-0 modal-bg flex items-center justify-center p-4 z-[510]">
        <div class="bg-white rounded-[2rem] w-full max-w-lg max-h-[85vh] flex flex-col overflow-hidden shadow-2xl">
            <div class="p-5 border-b bg-indigo-700 text-white flex justify-between items-center">
                <div>
                    <b class="text-xl">üìä ‡∫õ‡∫∞‡∫´‡∫ß‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫Ç‡∫≤‡∫ç</b>
                    <p id="m-summary" class="text-[10px] bg-white/20 rounded-full px-2 py-0.5 mt-1"></p>
                </div>
                <button onclick="closeM('histM')" class="text-2xl">‚úï</button>
            </div>
            <div id="h-list" class="overflow-y-auto p-4 space-y-3 bg-slate-50 flex-1"></div>
        </div>
    </div>

    <div id="receipt-print-area" class="fixed -left-[2000px] top-0"></div>
    <div id="toast" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 px-10 py-4 rounded-3xl text-white z-[1000] text-sm font-bold shadow-2xl transition-all"></div>

<script>
/* * M4T POS CORE ENGINE v3.1 
 * Security-First & Performance Optimized
 */
const PASS = "212004";
let bleDevice, bleCharacteristic;

// Persistence Engine
const getStore = (key, def) => JSON.parse(localStorage.getItem(key)) || def;
const setStore = (key, val) => localStorage.setItem(key, JSON.stringify(val));

let items = getStore('m4t_items', [
    {id:1, n:"‡∫ô‡ªâ‡∫≥‡∫î‡∫∑‡ªà‡∫°‡∫ö‡ªç‡∫•‡∫¥‡∫™‡∫∏‡∫î", p:5000, c:"‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°", img:"https://images.unsplash.com/photo-1548919973-5dea5846f669?w=300"},
    {id:2, n:"‡∫Å‡∫≤‡ªÄ‡∫ü‡ªÄ‡∫¢‡∫±‡∫ô", p:25000, c:"‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫°", img:"https://images.unsplash.com/photo-1517701604599-bb29b565090c?w=300"}
]);
let shop = getStore('m4t_shop', { n: "M4T POS SHOP", t: "‡∫Æ‡ªâ‡∫≤‡∫ô‡∫Ñ‡ªâ‡∫≤ POS | 020 1234 5678", q: "" });
let sales = getStore('m4t_v3', []);
let cart = [], curCat = 'all';

const el = id => document.getElementById(id);
const openM = id => { const m = el(id); m.classList.remove('hidden'); m.classList.add('animate-in', 'fade-in', 'zoom-in'); };
const closeM = id => el(id).classList.add('hidden');

// Bluetooth Logic
async function connectBT() {
    try {
        msg("üîå ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤ Bluetooth...", "bg-blue-500");
        bleDevice = await navigator.bluetooth.requestDevice({
            acceptAllDevices: false,
            filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }, { namePrefix: 'MTP' }, { namePrefix: 'RPP' }],
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });
        const server = await bleDevice.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        const chars = await service.getCharacteristics();
        bleCharacteristic = chars.find(c => c.properties.write || c.properties.writeWithoutResponse);
        el('bt-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> Bluetooth: ‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà‡ªÅ‡∫•‡ªâ‡∫ß`;
        el('bt-status').classList.add('connected');
        msg("‚úÖ ‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà‡∫õ‡∫£‡∫¥‡∫ô‡ªÄ‡∫ï‡∫µ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!");
    } catch (e) { 
        console.error(e);
        msg("‚ùå ‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà‡ªÑ‡∫î‡ªâ", "bg-red-500"); 
    }
}

// Rendering Engine (Optimized)
function render() {
    const q = el('search').value.toLowerCase();
    const filtered = items.filter(i => (curCat === 'all' || i.c === curCat) && i.n.toLowerCase().includes(q));
    
    el('prod-grid').innerHTML = filtered.map(i => `
        <div onclick="add(${i.id})" class="product-card bg-white rounded-[1.5rem] shadow-sm border border-gray-100 overflow-hidden cursor-pointer relative">
            <div class="h-28 overflow-hidden bg-gray-50">
                <img src="${i.img || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover">
            </div>
            <div class="p-3">
                <h3 class="text-[11px] font-bold text-gray-800 truncate">${i.n}</h3>
                <p class="text-indigo-600 font-black text-[13px] mt-1">${i.p.toLocaleString()} ‚Ç≠</p>
            </div>
        </div>`).join('');
    
    const cats = ['all', ...new Set(items.map(i => i.c))];
    el('cats').innerHTML = cats.map(c => `
        <button onclick="setCat('${c}')" class="${curCat===c ? 'bg-indigo-600 text-white shadow-indigo-200' : 'bg-white text-gray-500'} px-5 py-2 rounded-2xl text-[11px] font-bold border shadow-sm whitespace-nowrap transition-all">
            ${c === 'all' ? 'üõçÔ∏è ‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î' : c}
        </button>
    `).join('');
    el('qr-img').src = shop.q;
    el('head-title').innerHTML = `${shop.n}<br><span class="text-[9px] font-normal opacity-70">‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫Ç‡∫≤‡∫ç‡∫≠‡∫±‡∫î‡∫™‡∫∞‡∫•‡∫¥‡∫ç‡∫∞</span>`;
}

function setCat(c) { curCat = c; render(); }
function add(id) { 
    const x = cart.find(i => i.id === id); 
    x ? x.q++ : cart.push({...items.find(i => i.id === id), q:1}); 
    updCart(); 
}
function qty(id, d) { 
    const i = cart.find(x => x.id === id); 
    if(i) i.q += d; 
    cart = cart.filter(x => x.q > 0); 
    updCart(); 
}

function updCart() {
    let t = 0;
    el('cart-list').innerHTML = cart.length ? cart.map(i => { 
        t += i.p * i.q; 
        return `
        <div class="flex justify-between items-center bg-indigo-50/50 p-3 rounded-2xl border border-indigo-100 text-xs animate-in slide-in-from-right-2">
            <div class="flex-1 truncate pr-2">
                <b class="text-gray-800">${i.n}</b>
                <div class="text-[10px] text-indigo-500 font-bold">${i.p.toLocaleString()} ‚Ç≠</div>
            </div>
            <div class="flex items-center gap-3 bg-white p-1 rounded-xl shadow-sm border">
                <button onclick="qty(${i.id},-1)" class="w-7 h-7 flex items-center justify-center text-red-500 font-bold">-</button>
                <b class="w-4 text-center text-sm">${i.q}</b>
                <button onclick="qty(${i.id},1)" class="w-7 h-7 flex items-center justify-center text-green-600 font-bold">+</button>
            </div>
        </div>` }).join('') : `<div class="h-full flex flex-col items-center justify-center opacity-20"><span class="text-5xl">üõí</span><p>‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÉ‡∫ô‡∫ï‡∫∞‡∫Å‡ªâ‡∫≤</p></div>`;
    el('c-count').innerText = cart.length;
    el('g-total').innerText = t.toLocaleString() + ' ‚Ç≠';
}

async function pay() {
    const total = cart.reduce((a,b)=>a+(b.p*b.q),0), rVal = +el('rec').value || 0, pm = document.querySelector('input[name="pm"]:checked').value, st = el('st').value;
    
    if(!cart.length) return msg('‚ö†Ô∏è ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫Å‡ªà‡∫≠‡∫ô!','bg-orange-500');
    if(pm==='‡ªÄ‡∫á‡∫¥‡∫ô‡∫™‡∫ª‡∫î' && st==='‡∫à‡ªà‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß' && rVal < total) return msg('‚ùå ‡∫Æ‡∫±‡∫ö‡ªÄ‡∫á‡∫¥‡∫ô‡∫ö‡ªç‡ªà‡∫Ñ‡∫ª‡∫ö‡∫ï‡∫≤‡∫°‡∫ç‡∫≠‡∫î!','bg-red-600');
    
    const s = { 
        id: 'M4T' + Math.random().toString(36).substr(2, 6).toUpperCase(), 
        items: JSON.stringify(cart), total, pm, st, 
        dd: el('dd').value, cus: el('cus').value || '‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤‡∫ó‡∫ª‡ªà‡∫ß‡ªÑ‡∫õ', 
        rec: pm==='‡ªÄ‡∫á‡∫¥‡∫ô‡∫™‡∫ª‡∫î' ? rVal : total, 
        chg: (rVal > total ? rVal - total : 0), 
        time: new Date() 
    };
    
    sales.push(s); 
    setStore('m4t_v3', sales);
    
    msg('üßæ ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫™‡ªâ‡∫≤‡∫á‡ªÉ‡∫ö‡∫ö‡∫¥‡∫ô...');
    await printProcess(s);
    
    cart = []; updCart(); 
    el('rec').value = el('cus').value = el('dd').value = ''; 
    setQR(0);
}

async function printProcess(s) {
    const its = JSON.parse(s.items);
    const printEl = el('receipt-print-area');
    
    // Generate Dense Watermark Grid
    let wmContent = '';
    for(let i=0; i<32; i++) wmContent += `<div class="wm-item">${s.id}</div>`;

    printEl.innerHTML = `
        <div id="r-cap" class="relative p-8 w-[380px] bg-white text-black border shadow-lg overflow-hidden">
            <div class="wm-container">${wmContent}</div>
            
            <div class="relative z-10 text-center">
                <div class="w-16 h-16 bg-indigo-700 text-white rounded-2xl flex items-center justify-center text-2xl font-black mx-auto mb-3 shadow-lg">M4T</div>
                <h2 class="font-black text-2xl leading-none uppercase text-gray-900">${shop.n}</h2>
                <p class="text-[11px] text-gray-500 mt-2 font-bold">${shop.t}</p>
                
                <div class="border-t-2 border-dashed border-gray-200 my-4"></div>
                
                <div class="text-left text-[11px] space-y-1 bg-gray-50 p-3 rounded-2xl border border-gray-100">
                    <div class="flex justify-between"><span>‡ªÄ‡∫•‡∫Å‡∫ö‡∫¥‡∫ô (ID):</span><span class="font-black text-indigo-700">#${s.id}</span></div>
                    <div class="flex justify-between"><span>‡∫ß‡∫±‡∫ô‡∫ó‡∫µ:</span><span>${new Date(s.time).toLocaleString('lo-LA')}</span></div>
                    <div class="flex justify-between"><span>‡∫•‡∫π‡∫Å‡∫Ñ‡ªâ‡∫≤:</span><span class="font-bold">${s.cus}</span></div>
                    <div class="flex justify-between"><span>‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞:</span><span class="px-2 bg-indigo-100 rounded-lg text-[10px]">${s.st}</span></div>
                </div>

                <div class="my-4 text-left">
                    <div class="flex text-[10px] font-bold text-gray-400 uppercase px-1 mb-2">
                        <span class="flex-1">‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô</span>
                        <span class="w-16 text-right">‡∫•‡∫ß‡∫°</span>
                    </div>
                    <div class="space-y-3">
                        ${its.map(i => `
                        <div class="flex justify-between text-[12px] items-start">
                            <div class="text-left flex-1 pr-4">
                                <div class="font-black text-gray-800">${i.n}</div>
                                <div class="text-[10px] text-gray-400 font-bold">${i.p.toLocaleString()} x ${i.q}</div>
                            </div>
                            <span class="font-black text-gray-900">${(i.p*i.q).toLocaleString()}</span>
                        </div>`).join('')}
                    </div>
                </div>

                <div class="border-t-2 border-dashed border-gray-200 my-4"></div>
                
                <div class="flex justify-between items-center py-1">
                    <span class="font-bold text-gray-500 uppercase text-xs">‡∫ç‡∫≠‡∫î‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î:</span>
                    <span class="font-black text-2xl text-indigo-700 tracking-tighter">${s.total.toLocaleString()} ‚Ç≠</span>
                </div>

                <div class="bg-indigo-900 text-white p-4 mt-4 rounded-[1.5rem] space-y-1 shadow-inner">
                    <div class="flex justify-between text-[11px] opacity-80"><span>‡∫ä‡∫≥‡∫•‡∫∞‡∫ú‡ªà‡∫≤‡∫ô (${s.pm}):</span><span>${s.rec.toLocaleString()}</span></div>
                    <div class="flex justify-between text-[12px] font-black border-t border-white/20 pt-1 mt-1"><span>‡ªÄ‡∫á‡∫¥‡∫ô‡∫ó‡∫≠‡∫ô:</span><span>${s.chg.toLocaleString()} ‚Ç≠</span></div>
                </div>

                <div class="mt-8 text-center">
                    <div class="inline-block px-4 py-1 border-2 border-gray-900 rounded-full font-black text-[10px] uppercase">Thank You</div>
                    <p class="text-[9px] mt-2 font-bold text-gray-300">Powered by M4T POS System Professional</p>
                </div>
            </div>
        </div>`;
    
    await new Promise(r => setTimeout(r, 600)); // Buffer for rendering
    
    try {
        const canvas = await html2canvas(el('r-cap'), { 
            scale: 3, 
            useCORS: true, 
            backgroundColor: "#ffffff",
            logging: false 
        });
        
        if (bleCharacteristic) {
            const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 0.9));
            await sendToPrinter(blob);
        } else {
            const link = document.createElement('a');
            link.download = `M4T_Receipt_${s.id}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            msg("üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÉ‡∫ö‡∫ö‡∫¥‡∫ô‡∫•‡∫ª‡∫á‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡ªÅ‡∫•‡ªâ‡∫ß");
        }
    } catch (err) {
        msg("‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫™‡ªâ‡∫≤‡∫á‡∫ö‡∫¥‡∫ô", "bg-red-500");
    }
}

async function sendToPrinter(blob) {
    if (!bleCharacteristic) return;
    const buf = await blob.arrayBuffer();
    const data = new Uint8Array(buf);
    const step = 120; // MTU Size Optimization
    for (let i = 0; i < data.length; i += step) {
        await bleCharacteristic.writeValue(data.slice(i, i + step));
        await new Promise(r => setTimeout(r, 20)); // Flow control
    }
}

// Utility Helpers
function askPass() { 
    const p = prompt("üîê ‡∫õ‡ªâ‡∫≠‡∫ô‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ú‡ªà‡∫≤‡∫ô‡∫ú‡∫π‡ªâ‡∫î‡∫π‡ªÅ‡∫•:");
    if(p === PASS) openM('adminM'); 
    else if(p !== null) msg("‚ùå ‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ú‡ªà‡∫≤‡∫ô‡∫ö‡ªç‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á!","bg-red-600"); 
}

function saveShop() {
    shop = { n: el('s-n').value || shop.n, t: el('s-t').value || shop.t, q: el('s-q').value || shop.q };
    setStore('m4t_shop', shop);
    msg("‚úÖ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î"); render(); closeM('shopM');
}

function saveProd() {
    const n = el('p-n').value, p = +el('p-p').value, c = el('p-c').value, img = el('p-i').value;
    if(!n || !p) return msg("‚ö†Ô∏è ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫ä‡∫∑‡ªà ‡ªÅ‡∫•‡∫∞ ‡∫•‡∫≤‡∫Ñ‡∫≤!","bg-red-600");
    items.push({ id: Date.now(), n, p, c: c || '‡∫≠‡∫∑‡ªà‡∫ô‡ªÜ', img });
    setStore('m4t_items', items);
    render(); updPList();
    el('p-n').value = el('p-p').value = el('p-c').value = el('p-i').value = '';
    msg("üì¶ ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÅ‡∫•‡ªâ‡∫ß");
}

function updPList() {
    el('p-list').innerHTML = items.map(i => `
        <div class="flex justify-between items-center p-3 bg-white rounded-2xl border border-gray-100 shadow-sm">
            <div class="flex items-center gap-3">
                <img src="${i.img || 'https://via.placeholder.com/150'}" class="w-10 h-10 rounded-lg object-cover">
                <div class="text-xs">
                    <b class="text-gray-800">${i.n}</b><br>
                    <span class="text-indigo-600 font-bold">${i.p.toLocaleString()} ‚Ç≠</span>
                </div>
            </div>
            <button onclick="delP(${i.id})" class="w-8 h-8 flex items-center justify-center text-red-400 bg-red-50 rounded-full">‚úï</button>
        </div>`).join('');
}

function delP(id) { 
    if(confirm('‡∫•‡∫∂‡∫ö‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫ô‡∫µ‡ªâ?')) {
        items = items.filter(i=>i.id!==id); 
        setStore('m4t_items', items); 
        render(); updPList(); 
    }
}

function showHist() {
    openM('histM');
    const now = new Date();
    const mSales = sales.filter(s => new Date(s.time).getMonth() === now.getMonth());
    const mTotal = mSales.reduce((a,b)=>a+b.total,0);
    el('m-summary').innerText = `‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô‡∫ô‡∫µ‡ªâ: ${mTotal.toLocaleString()} ‚Ç≠ | ${mSales.length} ‡∫ö‡∫¥‡∫ô`;
    
    el('h-list').innerHTML = sales.length ? sales.sort((a,b)=>new Date(b.time)-new Date(a.time)).map(s => `
        <div class="bg-white p-4 rounded-2xl border border-gray-100 flex justify-between items-center shadow-sm">
            <div class="text-[11px]">
                <b class="text-indigo-700 text-xs">${s.cus}</b>
                <div class="opacity-50 font-bold">${new Date(s.time).toLocaleString('lo-LA')}</div>
                <div class="mt-1"><span class="bg-gray-100 px-2 py-0.5 rounded text-[9px]">${s.pm}</span></div>
            </div>
            <div class="text-right">
                <b class="text-sm text-gray-800">${s.total.toLocaleString()} ‚Ç≠</b>
                <div class="flex gap-2 mt-2">
                    <button onclick="reP('${s.id}')" class="text-indigo-600 text-[10px] bg-indigo-50 px-3 py-1 rounded-xl font-bold border border-indigo-100">‡∫û‡∫¥‡∫°‡∫Ñ‡∫∑‡∫ô</button>
                    <button onclick="delS('${s.id}')" class="text-red-400 text-[10px] font-bold">‡∫•‡∫∂‡∫ö</button>
                </div>
            </div>
        </div>`).join('') : `<p class="text-center opacity-30 py-10">‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫õ‡∫∞‡∫´‡∫ß‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫Ç‡∫≤‡∫ç</p>`;
}

function delS(id) { 
    if(confirm('‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫∂‡∫ö‡∫õ‡∫∞‡∫´‡∫ß‡∫±‡∫î‡∫ö‡∫¥‡∫ô‡∫ô‡∫µ‡ªâ?')) { 
        sales = sales.filter(s=>s.id!==id); 
        setStore('m4t_v3', sales); 
        showHist(); 
    } 
}

function reP(id) { 
    const s = sales.find(x => x.id === id); 
    if(s) { printProcess(s); msg("üßæ ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫û‡∫¥‡∫°‡∫ö‡∫¥‡∫ô‡∫Ñ‡∫∑‡∫ô..."); } 
}

function exportData() {
    const data = JSON.stringify({ items, shop, sales });
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `M4T_POS_BACKUP_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    msg("üíæ Backup ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß");
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
        const reader = new FileReader();
        reader.onload = rs => {
            try {
                const d = JSON.parse(rs.target.result);
                setStore('m4t_items', d.items);
                setStore('m4t_shop', d.shop);
                setStore('m4t_v3', d.sales);
                msg("‚úÖ Restore Data ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!");
                setTimeout(() => location.reload(), 1000);
            } catch(e) { msg("‚ùå ‡ªÑ‡∫ü‡∫•‡ªå‡∫ö‡ªç‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á", "bg-red-500"); }
        };
        reader.readAsText(e.target.files[0]);
    };
    input.click();
}

function clearAllData() { 
    if(confirm("‚ùó ‡∫Ñ‡∫≥‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô: ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î‡∫à‡∫∞‡∫ñ‡∫∑‡∫Å‡∫•‡∫∂‡∫ö‡∫ñ‡∫≤‡∫ß‡∫≠‡∫ô. ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô?")) { 
        localStorage.clear(); 
        location.reload(); 
    } 
}

function msg(m, c='bg-green-600') { 
    const t = el('toast'); 
    t.innerText = m; 
    t.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-10 py-4 rounded-3xl text-white z-[1000] text-sm font-bold shadow-2xl animate-in fade-in slide-in-from-bottom-5 ${c}`; 
    t.classList.remove('hidden'); 
    setTimeout(()=>t.classList.add('hidden'), 3000); 
}

function debtTog() { 
    const isDebt = el('st').value === '‡∫ï‡∫¥‡∫î‡ªú‡∫µ‡ªâ';
    el('dd').classList.toggle('hidden', !isDebt); 
    if(isDebt) el('dd').focus();
}

function setQR(sw) { 
    if(sw && !shop.q) {
        msg("‚ö†Ô∏è ‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤ QR Code ‡∫Æ‡∫±‡∫ö‡ªÄ‡∫á‡∫¥‡∫ô", "bg-orange-500");
        return;
    }
    el('qrM').classList.toggle('hidden', !sw); 
}

// Initial Boot
window.onload = () => {
    render(); 
    updPList();
    el('s-n').value = shop.n; 
    el('s-t').value = shop.t; 
    el('s-q').value = shop.q;
};
</script>
</body>
</html>
